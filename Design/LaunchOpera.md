# 启动剧情组件（Alpha内测）

  Unity微信小游戏首次启动会花费较长的加载时间，这段等待期间游戏与玩家之间没有更多的交互，这是新用户的留存率影响的重要因素，因此微信小游戏为开发者提供「启动剧情组件」能力，在这能力下，能够为玩家提供更早的交互行为，为游戏资源的下载以及初始化逻辑的运行争取了大量时间，因此对于希望进一步提升游戏启动留存的开发者基于该组件精心设计用于“迎新”的剧情内容，可以提升良好的游戏体验。
  同时「启动剧情组件」已经涵盖原封面视频能力，并能提供更多丰富的功能，因此为节约代码包体积，原封面视频能力将逐步下架，开发者应较早适配至「启动剧情组件」。

## 演示效果

  <等待优秀游戏作品入驻>


## 能力特性

- 更早的运行时机
- 独立线程
- 支持适应不同设备下的播放体验
- 支持区分新老用户不同的播放内容
- 支持视频、插图等形式展现
- 剧情结束后开发者能够感知用户的一些交互行为，进而可影响后续游戏发展（如礼包、门派选择等）

## 推荐内容

- 游戏世界观、故事背景的介绍
- 游戏厂家启动Logo、防沉迷等信息披露
- 前置新人、赛季CG动画短片

## 接入方式

由于启动剧情为Unity启动加载耗时过久而推出的能力，因此启动剧情需要使用 JavaScript 完成接入（早于C# wasm初始化），接入前请先了解 [微信小游戏包JavaScript扩展](Design/javascriptExt.md) 章节。 

启动剧情相关初始化配置请在 `launchOperaInit` 回调事件完成，初始化期间必须使用同步方法完成，例如读取本地缓存需使用 `Sync` 方式进行读取，如需网络交互请阅读[基于异步（网络）干预剧情发展](#基于异步网络干预剧情发展)章节。
```js
// 案例 main.js
GameGlobal.event.on("launchOperaInit", (operaHandler) => {

  // 如需读取本地缓存请使用 getStorageSync 读取，请勿使用异步方式
  let play = true;
  try {
    var value = wx.getStorageSync('launchOperaLocalDataXXX'); // 自行管理的本地缓存 Key-Value
    if (value) {    // 本地有特定缓存标识意味已经不是首次访问可以不播放
      play = false;
    }
  } catch (e) { }

  // 开始配置启动剧情
  operaHandler.config = { // 配置本地剧本路径，若 playPath 文件不存在或读取失败则自动放弃启动剧情
    playPath: play ? './operaPlay.wxlop' : null,
  }

  // 注册一些其他的启动剧情事件回调

  operaHandler.onEnd((logger) => {
    console.log('剧情播放结束');
  })

  operaHandler.onErr((err) => {
    console.log('发生异常');
    operaHandler.end();       // 发生异常时强制结束，避免用户无法退出剧情插件模式
  })

});

```

### 基于异步（网络）干预剧情发展

初始化期间可以同步读取本地资源简单判断是否需要播放剧情，但对于有网络存档的游戏而言，显然不是可靠的判断新用户的方案（用户新设备或本地缓存丢失时也将判定为新用户），这将涉及到异步方式来干预启动剧情插件的工作。异步由于存在不确定的结果返回时间，游戏的启动自然不能始终等待这段空隙，因此在异步结果返回前，我们应让启动剧情插件正常启动，并在后续合理的时机完成故事线的切换。下图给出一种推荐的做法：


我们可以看到，默认的剧情将固定播放一段大约3～5秒钟的启动动画（可以是游戏厂家Logo、防沉迷提醒等），在3～5秒期间 JavaScript 脚本尝试用一些途径来确定后续的剧情发展（可以通过网络交互、本地读取等），当确认后，启动剧情插件允许配置相关变量进而干预剧情发展。
值得注意的是，异步的获取时间明显是不可控的，因此是有可能在5秒的启动动画结束后，仍未得到期望的结果，因此推荐的设计是默认情况下仅播放5秒的启动动画，后续剧情不播放，当5秒内明确了后续播与不播放的选择时，按结果配置，若仍未得到结果，可以按照老用户立即结束剧情即可。具体如何抉择，开发者可以自行设计。


### C#代码中的实现
考虑到Unity开发者更多的是擅长C#的语言开发，启动剧情仍然提供了一些C#的后续交互接口（如后续的剧情分析logger、读写变量值等）


### 自定义上报分析

启动剧情是一个持续较长时间的业务内容，这段时间中任何时刻均会有用户离开，因此上报剧情期间用户不同阶段的行为对于分析剧情内容与留存率是非常重要的。启动剧情的“剧本”由开发者定义，因此开发者更清楚一个剧情的不同阶段的时间点，所以需要开发者自行对不同阶段剧情进行上报打点。开发者配置上报后，MP管理后台提供了漏斗图的数据可视化看板，将方便开发者进行数据分析。

